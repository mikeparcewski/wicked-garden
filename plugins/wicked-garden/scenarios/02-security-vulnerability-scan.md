---
name: security-vulnerability-scan
title: Security Review and Vulnerability Assessment
description: Comprehensive security review of an API codebase with OWASP compliance, secrets detection, and remediation guidance
type: security
difficulty: intermediate
estimated_minutes: 12
---

# Security Review and Vulnerability Assessment

This scenario demonstrates wicked-platform's security review capabilities, including OWASP Top 10 detection, secrets scanning, and actionable remediation guidance.

## Setup

Create an API with intentional security issues for testing:

```bash
# Create test project with security vulnerabilities
mkdir -p ~/test-wicked-platform/vulnerable-api/src
cd ~/test-wicked-platform/vulnerable-api

# Create a controller with SQL injection vulnerability
cat > src/users.ts << 'EOF'
import { Request, Response } from 'express';
import db from './database';

// Intentionally vulnerable for testing
const API_KEY = "sk-prod-abc123def456ghi789";  // Hardcoded secret

export async function getUser(req: Request, res: Response) {
  const userId = req.params.id;

  // SQL Injection vulnerability - string concatenation
  const query = `SELECT * FROM users WHERE id = ${userId}`;
  const result = await db.query(query);

  res.json(result.rows);
}

export async function searchUsers(req: Request, res: Response) {
  const name = req.query.name;

  // Another SQL injection point
  const users = await db.query(`SELECT * FROM users WHERE name LIKE '%${name}%'`);

  // XSS vulnerability - unescaped output
  res.send(`<h1>Results for: ${name}</h1>`);
}

export async function login(req: Request, res: Response) {
  try {
    // Authentication logic
    const user = await authenticate(req.body);
    res.json({ token: generateToken(user) });
  } catch (error) {
    // Verbose error exposure
    res.status(401).json({
      error: error.message,
      stack: error.stack,
      query: `SELECT * FROM users WHERE email = '${req.body.email}'`
    });
  }
}
EOF

# Create command injection vulnerability
cat > src/admin.ts << 'EOF'
import { exec } from 'child_process';
import { Request, Response } from 'express';

export async function generateReport(req: Request, res: Response) {
  const filename = req.body.filename;

  // Command injection vulnerability
  exec(`cat /reports/${filename} | wc -l`, (err, stdout) => {
    res.json({ lines: stdout });
  });
}

export async function pingHost(req: Request, res: Response) {
  const host = req.query.host;

  // Another command injection point
  exec(`ping -c 3 ${host}`, (err, stdout) => {
    res.send(stdout);
  });
}
EOF

# Create package.json
cat > package.json << 'EOF'
{
  "name": "vulnerable-api",
  "version": "1.0.0",
  "dependencies": {
    "express": "^4.17.1",
    "lodash": "4.17.4",
    "jsonwebtoken": "8.5.0"
  }
}
EOF

# Initialize git
git init
git add -A
git commit -m "Initial commit"
```

## Steps

### 1. Run Full Security Review

```bash
/wicked-platform:security src/
```

**Expected**:
- Spawns security-engineer agent
- Scans for OWASP Top 10 vulnerabilities
- Detects hardcoded secrets
- Identifies injection points
- Provides remediation for each finding

### 2. Review Critical Findings

The security report should identify:

**Critical (P0)**:
- [ ] SQL injection in `getUser()` - string concatenation with user input
- [ ] SQL injection in `searchUsers()` - unparameterized query
- [ ] Command injection in `generateReport()` - unvalidated shell exec
- [ ] Command injection in `pingHost()` - direct user input to exec
- [ ] Hardcoded API key in `users.ts`

**High (P1)**:
- [ ] XSS vulnerability - unescaped HTML output
- [ ] Verbose error messages exposing SQL queries and stack traces
- [ ] Outdated lodash with known vulnerabilities

### 3. Check Dependency Vulnerabilities

```bash
/wicked-platform:security --deps-only
```

**Expected**:
- Checks npm audit
- Identifies vulnerable lodash version
- Recommends upgrade paths

### 4. Verify Remediation Guidance

For each finding, the security review should provide:

```markdown
### SQL Injection - src/users.ts:10

**Risk**: CRITICAL
**OWASP**: A03:2021-Injection

**Vulnerable Code**:
```typescript
const query = `SELECT * FROM users WHERE id = ${userId}`;
```

**Remediation**:
```typescript
// Use parameterized queries
const query = 'SELECT * FROM users WHERE id = $1';
const result = await db.query(query, [userId]);
```

**Why this matters**: Attackers can manipulate the query to access unauthorized data, modify records, or execute admin commands.
```

### 5. Generate OWASP Compliance Matrix

```bash
/wicked-platform:security full --owasp
```

**Expected**:
A compliance matrix showing status for each OWASP category:

| Category | Status | Issues |
|----------|--------|--------|
| A01 Broken Access Control | NEEDS REVIEW | 0 |
| A02 Cryptographic Failures | PASS | 0 |
| A03 Injection | FAIL | 4 |
| A04 Insecure Design | PASS | 0 |
| A05 Security Misconfiguration | FAIL | 1 |
| A06 Vulnerable Components | FAIL | 1 |
| A07 Auth Failures | NEEDS REVIEW | 0 |
| A08 Data Integrity | PASS | 0 |
| A09 Logging Failures | FAIL | 1 |
| A10 SSRF | PASS | 0 |

## Expected Outcome

A comprehensive security report:

```markdown
## Security Review Report

**Scope**: src/
**Risk Level**: CRITICAL
**Findings**: 8 (4 Critical, 2 High, 2 Medium)

### Critical Findings

1. **SQL Injection** - `src/users.ts:10`
   - User input directly concatenated into SQL query
   - Allows unauthorized data access, modification, or deletion
   - Fix: Use parameterized queries

2. **SQL Injection** - `src/users.ts:20`
   - Search parameter unsanitized in LIKE clause
   - Fix: Use parameterized query with escaped wildcards

3. **Command Injection** - `src/admin.ts:8`
   - Filename passed directly to shell exec
   - Allows arbitrary command execution
   - Fix: Validate against allowlist, use safe file operations

4. **Hardcoded Secret** - `src/users.ts:5`
   - Production API key in source code
   - Fix: Move to environment variable, rotate immediately

### High Findings

5. **XSS Vulnerability** - `src/users.ts:23`
   - User input rendered as unescaped HTML
   - Fix: Use proper templating with auto-escape

6. **Verbose Error Messages** - `src/users.ts:35`
   - Stack traces and SQL queries exposed in errors
   - Fix: Log details server-side, return generic client errors

### Dependency Vulnerabilities

- lodash 4.17.4: Prototype pollution (CVE-2019-10744)
  Upgrade to: lodash ^4.17.21

### Recommendations

**Immediate**:
1. Rotate exposed API key
2. Fix SQL injection vulnerabilities
3. Remove command injection paths

**Short-term**:
1. Implement input validation middleware
2. Update vulnerable dependencies
3. Configure error handling to hide internals
```

## Success Criteria

- [ ] All SQL injection vulnerabilities detected
- [ ] Command injection vulnerabilities identified
- [ ] Hardcoded secret flagged
- [ ] XSS vulnerability found
- [ ] Dependency vulnerabilities listed
- [ ] Each finding has clear remediation
- [ ] OWASP compliance status generated
- [ ] Findings prioritized by risk level

## Value Demonstrated

**Problem solved**: Security reviews are expensive and time-consuming. Most codebases ship with known vulnerability patterns because developers lack security expertise or time for thorough reviews.

**Why this matters**:

1. **Shift-left security**: Find vulnerabilities during development, not after breach. The security-engineer agent catches issues that would otherwise reach production.

2. **OWASP expertise on demand**: Developers don't need to memorize the OWASP Top 10. The plugin applies that knowledge automatically.

3. **Actionable remediation**: Each finding includes working code examples, not just abstract guidance. Developers can fix issues immediately.

4. **Compliance readiness**: The OWASP matrix provides documentation for security audits and compliance requirements.

5. **Continuous improvement**: Running `/security` before every PR creates a security-conscious development culture.

This replaces expensive periodic security audits with continuous, automated security review integrated into the development workflow. A professional penetration test costs $5,000-$50,000 and happens annually. wicked-platform provides similar vulnerability detection on every commit.
